<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>7.1 Saving Created Tweets In Cookies | Shane Burkhart</title>
<meta name="viewport" content="width=device-width">

<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet" type="text/css">

<!-- Custom CSS -->
<link rel="stylesheet" href="/assets/css/application.css">

    </head>
    <body>
        <header>
    <div class="container">
        <nav class="pull-left">
            <a id="site-logo">Spark School</a>
        </nav>
        
        <h3 id="section-name" class="pull-right">Day 7: Restrict Updating And Deleting Tweets</h3>
        
    </div>
</header>

        <main class="container">
            <h1>7.1 Saving Created Tweets In Cookies</h1>
            <article>
                <p>Welcome to day 7 of the Twitter clone course.  Yesterday, we added a delete button for our tweets and deleted them from the database.  Today, we are going to add a little user authentication so only the computer that created the tweet can edit the tweet. Let’s get started.</p>

<p>HTTP is stateless which means each request is isolated and doesn’t know about any other request.  This makes it hard to associate requests with a specific user since each request only knows what we pass to it and not what happened on other requests. Because we need a way to keep track of which requests belong to each user, we use cookies.</p>

<p>Cookies are simply data that is stored in the user’s browser. At minimum, each cookie contains a name and a value.  For instance, we might have a cookie named “user_id” that stores the id of the user that is logged in.</p>

<p>On each request, the browser will send all of the cookies for the domain to the web server.  The web server then uses these cookies for data that is specific to the user.  In the case of the “user_id” cookie, the web server would use that id to get the user’s information from the database.</p>

<p>Web servers can also set cookies in the browser.  To do this, the web server sends back the cookies to set on the response and the browser will update its cookies. Each browser on a computer has it’s own set of cookies.  So a cookie is not only specific to a computer, but also to a browser on that computer.</p>

<p>For this course, we don’t have users, so we are going to store the ids of tweets that were created.  We’ll give our cookie the name “tweets_created” and it’s value will be a list of ids.  We can use these ids to check if the user created the tweet they are trying to edit, update, or destroy.</p>

<p>Before we can start using cookies, we need to add middleware to parse cookies.  This middleware is called cookie-parser and it works much like body-parser.  Let’s install the cookie-parser library now.  Remember to add “--no-bin-links” if you are on Windows.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">npm install cookie-parser --save
</code></pre></div>
<p>With that installed, let’s require the cookie-parser library under our body-parser library.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">moment</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'moment'</span><span class="p">);</span>
</code></pre></div>
<p>To get the middleware and add it to our app, we simply call the “cookieParser” function, which returns the middleware, and pass it to “app.use”.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'./public'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
</code></pre></div>
<p>Now on each request, Express will parse cookies for us and add them to the request object with the key “cookies”.  The “cookies” object contains name-value pairs with the name of the cookie being the key.  To get our “tweets_created” cookie value, we can do the following.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">tweets_created</span>
</code></pre></div>
<p>With that out of the way, we need to start by saving the id of newly created tweets in a the “tweets_creatd” cookie.  We’ll add this to the create tweet route.</p>

<p>Each time the user creates a tweet, we need to get the “tweets<em>created” cookie, add the new tweet id, and then set the “tweets</em>created” cookie to the new list.  Let’s add the code to get the tweets created and save it again to the “tweets_created” cookie.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/tweets/create'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">'INSERT INTO Tweets(handle, body) VALUES(?, ?)'</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">handle</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">tweetsCreated</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">tweets_created</span> <span class="o">||</span> <span class="p">[];</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">body</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">'tweets_created'</span><span class="p">,</span> <span class="nx">tweetsCreated</span><span class="p">,</span> <span class="p">{</span> <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>We are using the “or” operator when setting the “tweetsCreated” variable.  We are doing this because the first time a user creates a tweet, there won’t be any cookies set since they haven’t created a tweet yet.  This means that the “tweets<em>created” cookie will be undefined.  Since we want the cookie to be an array, we are using the “or” operator to set “tweetsCreated” to an empty array if the “tweets</em>created” cookies doesn’t exist.  If the “tweets_created” cookie does exist, then the empty array gets ignored and “tweetsCreated” is the array from the cookie.</p>

<p>In the query callback, just before the redirect, we are setting our “tweets_created” cookie.  We set cookies with the “cookies” method on the response parameter.  The first parameter to the “cookies” method is the name of the cookies and the second is the value the we are giving the cookie.  There is a third optional parameter, that takes an object with options for the cookie.  In this object, we can set things like expiration date and domain name that the cookie applies to.</p>

<p>For our cookies, we are setting the “httpOnly” option to true.  This option makes it so the cookie can only be accessed by the web server and not by client side javascript.  Don’t worry about this too much.  Just know that the having this option set means that only our web server can read the cookie.</p>

<p>We are setting our cookie, but we aren’t adding ids to our “tweetsCreated” array.  To do this, we need the id of the tweet that was just created.  There is a second parameter that is passed to our INSERT INTO query callback that contains the inserted id. Let’s add that parameter and call it “results”.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">body</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">'tweets_created'</span><span class="p">,</span> <span class="nx">tweetsCreated</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>The “results” parameter is an object that has a key called “insertId” that contains the id that was just inserted.  Let’s get that id and add it to our “tweetsCreated” array.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/tweets/create'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">'INSERT INTO Tweets(handle, body) VALUES(?, ?)'</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">handle</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">tweetsCreated</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">tweets_created</span> <span class="o">||</span> <span class="p">[];</span>

  <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="nx">handle</span><span class="p">,</span> <span class="nx">body</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">tweetsCreated</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">insertId</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">'tweets_created'</span><span class="p">,</span> <span class="nx">tweetsCreated</span><span class="p">);</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>To add a value to an array, we use the “push” method on the array.  The “push” method takes a single argument which is the value we want to add.  In our case we are adding the id of the tweet we just inserted.</p>

<p>Now if you restart your server and create a tweet, the tweet id will be in a cookie called “tweets_created”.  You can see the cookies for a site using the Google Chrome Developer Console.</p>

<p>I talked about the Chrome Developer Console a bit earlier when we were working with HTML and CSS.  To open the console, go to a chrome tab and right click on the page.  You should see an option that says “Inspect” or “Inspect Element”.  Click that and the developer console will open.</p>

<p><img src="https://s3.amazonaws.com/spark-school/courses/twitter-clone/7/7-1-inspect-element-option.png" alt=""></p>

<p>Go to the “Application” tab and there should be an item in the left hand column that says “Cookies”.  Open the drop down, and select “http://127.0.0.1:8080”.  In the right table, you will see the cookies for the site.</p>

<p><img src="https://s3.amazonaws.com/spark-school/courses/twitter-clone/7/7-1-chrome-dev-tools.png" alt=""></p>

<p>If you have created a tweet since adding cookies, you should see a cookie with the name “tweets_created” and it should have a value.  The value is URL encoded so it’s a little hard to read.  You should be good as long as the value isn’t blank.</p>

<p>We now have created tweet ids being saved in cookies, but we aren’t checking those ids to see if the user can edit a tweet.  To do this, we are going to use middleware.  In the next section, we are going to be going over middleware and how to create your own.</p>

                
                    <a href="/twitter-clone/7/2"> Click here to go the next lesson.</a>
                
            </article>
        </main>
    </body>
</html>
